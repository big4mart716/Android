name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    # ==== 1. 安装 Android SDK 核心组件 ====
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '12.0'
        accept-android-sdk-licenses: true
        packages: platform-tools platforms;android-34 build-tools;34.0.0
    
    # ==== 2. 验证安装 ====
    - name: Verify Android SDK installation
      run: |
        echo "=== Installed Android SDK packages ==="
        sdkmanager --list_installed
        echo ""
        echo "=== Environment variables ==="
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_HOME: $ANDROID_HOME"
    
    # ==== 3. 可选安装额外的包（不失败）===
    - name: Install optional packages
      continue-on-error: true
      run: |
        echo "Installing optional packages..."
        
        optional_packages=(
          "patcher;v4"
          "platforms;android-34-ext4"
          "platforms;android-34-ext8"
          "cmake;3.22.1"
          "ndk;25.2.9519653"
          "emulator"
        )
        
        for pkg in "${optional_packages[@]}"; do
          echo "Trying to install: $pkg"
          sdkmanager "$pkg" --verbose 2>/dev/null && echo "✓ $pkg installed" || echo "⚠ $pkg not found, skipping"
        done
    
    # ==== 4. 修复项目结构 ====
    - name: Fix project structure
      run: |
        echo "=== 当前项目结构 ==="
        ls -la
        echo ""
        
        echo "检查 Gradle 包装器..."
        if [ ! -f "./gradlew" ]; then
          echo "gradlew 不存在，生成必要的 Gradle 文件..."
          
          # 创建根目录的 build.gradle
          if [ ! -f "build.gradle" ]; then
            echo "创建根目录 build.gradle..."
            cat > build.gradle << 'EOF'
// Top-level build file
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath "com.android.tools.build:gradle:8.1.0"
    }
}
allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF
          fi
          
          # 创建 settings.gradle
          if [ ! -f "settings.gradle" ]; then
            echo "创建 settings.gradle..."
            echo "include ':app'" > settings.gradle
            echo "rootProject.name = 'PersonalCard'" >> settings.gradle
          fi
          
          # 安装 Gradle 并生成包装器
          echo "安装 Gradle 并生成包装器..."
          wget -q https://services.gradle.org/distributions/gradle-8.5-bin.zip
          unzip -q gradle-8.5-bin.zip
          ./gradle-8.5/bin/gradle wrapper
          
          echo "设置 gradlew 执行权限..."
          chmod +x ./gradlew
        else
          echo "gradlew 已存在"
        fi
        
        echo "项目结构修复完成"
    
    # ==== 5. 构建项目 ====
    - name: Build project
      run: |
        echo "开始构建 Android 项目..."
        echo "当前目录: $(pwd)"
        echo "项目结构:"
        ls -la
        
        if [ -f "./gradlew" ]; then
          echo "使用 gradlew 构建..."
          ./gradlew assembleDebug
        elif [ -f "app/build.gradle" ]; then
          echo "使用全局 gradle 构建..."
          gradle assembleDebug || echo "构建失败"
        else
          echo "错误：找不到构建文件"
          exit 1
        fi
    
    # ==== 6. 检查构建输出 ====
    - name: Check build outputs
      run: |
        echo "=== 查找生成的 APK 文件 ==="
        
        # 查找所有可能的 APK 路径
        find . -name "*.apk" -type f 2>/dev/null | while read file; do
          echo "找到 APK: $file"
          ls -la "$file"
        done || echo "没有找到 APK 文件"
        
        echo ""
        echo "=== 查看构建输出目录 ==="
        if [ -d "app/build/outputs" ]; then
          echo "app/build/outputs/ 存在:"
          find app/build/outputs/ -type f -name "*.apk" 2>/dev/null
        else
          echo "app/build/outputs/ 不存在"
          
          # 尝试查找其他可能的输出目录
          echo "查找其他构建目录..."
          find . -type d -name "outputs" 2>/dev/null
        fi
        
        echo ""
        echo "=== Gradle 构建报告 ==="
        if [ -d "app/build/reports" ]; then
          echo "构建报告存在"
        else
          echo "没有构建报告"
        fi
    
    # ==== 7. 上传构建产物 ====
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: |
          app/build/outputs/apk/
          app/build/reports/
        if-no-files-found: warn
