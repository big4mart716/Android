
  name: Android Build - PersonalCard

  on:
    push:
      branches: [ "main" ]
    pull_request:
      branches: [ "main" ]
    workflow_dispatch:

  jobs:
    build:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: gradle

        - name: Setup Android SDK
          uses: android-actions/setup-android@v3
          with:
            cmdline-tools-version: '12.0'
            accept-android-sdk-licenses: true

        - name: Install Android SDK components
          run: |
            echo "=== Installing Android SDK components ==="
            sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"
            echo "=== Installed packages ==="
            sdkmanager --list_installed

        - name: Grant execute permission for gradlew
          run: |
            if [ -f "PersonalCard/gradlew" ]; then
              chmod +x PersonalCard/gradlew
              echo "✓ gradlew 权限已设置"
            else
              echo "✗ gradlew 文件不存在"
              exit 1
            fi

        - name: Download Gradle wrapper if missing
          run: |
            cd PersonalCard
            if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
              echo "gradle-wrapper.jar is missing, downloading..."
              mkdir -p gradle/wrapper
              curl -L -o gradle/wrapper/gradle-wrapper.jar \
                https://raw.githubusercontent.com/gradle/gradle/v8.2.1/gradle/wrapper/gradle-wrapper.jar
            fi

        - name: Setup Gradle
          uses: gradle/actions/setup-gradle@v3
          with:
            build-root-directory: PersonalCard

        - name: Build with Gradle
          run: |
            cd PersonalCard
            ./gradlew assembleDebug --stacktrace

        - name: List build outputs
          if: always()
          run: |
            echo "=== Checking build outputs ==="
            ls -R PersonalCard/app/build/outputs/ 2>/dev/null || echo "No outputs directory found"
            echo ""
            echo "=== Looking for APK files ==="
            find PersonalCard -name "*.apk" -type f 2>/dev/null || echo "No APK files found"

        - name: Upload Debug APK
          uses: actions/upload-artifact@v4
          if: success()
          with:
            name: PersonalCard-debug
            path: PersonalCard/app/build/outputs/apk/debug/*.apk
            if-no-files-found: error
