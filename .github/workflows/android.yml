name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    # ==== 1. 安装 Android SDK 核心组件 ====
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '12.0'
        accept-android-sdk-licenses: true
        packages: platform-tools platforms;android-34 build-tools;34.0.0
    
    # ==== 2. 验证安装 ====
    - name: Verify Android SDK installation
      run: |
        echo "=== Installed Android SDK packages ==="
        sdkmanager --list_installed
        echo ""
        echo "=== Environment variables ==="
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_HOME: $ANDROID_HOME"
    
    # ==== 3. 可选安装额外的包（不失败）===
    - name: Install optional packages
      continue-on-error: true
      run: |
        echo "Installing optional packages..."
        
        optional_packages=(
          "patcher;v4"
          "platforms;android-34-ext4"
          "platforms;android-34-ext8"
          "cmake;3.22.1"
          "ndk;25.2.9519653"
          "emulator"
        )
        
        for pkg in "${optional_packages[@]}"; do
          echo "Trying to install: $pkg"
          sdkmanager "$pkg" --verbose 2>/dev/null && echo "✓ $pkg installed" || echo "⚠ $pkg not found, skipping"
        done
    
    # ==== 4. 修复的检查项目文件步骤（使用 echo 方法） ====
    - name: Check project files
      run: |
        echo "=== Project structure ==="
        ls -la
        echo ""
        
        if [ -f "app/build.gradle" ] || [ -f "build.gradle" ]; then
          echo "Android project detected"
          find . -name "*.gradle*" -type f 2>/dev/null
        else
          echo "No Android project found. Creating simple test project..."
          
          mkdir -p app/src/main/java/com/example
          
          # 使用 echo 命令逐行创建，避免 heredoc
          echo 'plugins {' > app/build.gradle
          echo '    id "com.android.application"' >> app/build.gradle
          echo '}' >> app/build.gradle
          echo '' >> app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    namespace "com.example.test"' >> app/build.gradle
          echo '    compileSdk 34' >> app/build.gradle
          echo '' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.example.test"' >> app/build.gradle
          echo '        minSdk 24' >> app/build.gradle
          echo '        targetSdk 34' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '}' >> app/build.gradle
          
          echo "Test project created"
        fi
    
    - name: Try to build
      run: |
        echo "Attempting to build Android project..."
        # 检查当前目录
        echo "Current directory: $(pwd)"
        ls -la

        # 尝试在 app/ 目录构建
        if [ -f "app/build.gradle" ]; then
        echo "Building app module..."
        cd app
        ./gradlew assembleDebug || gradle assembleDebug
        elif [ -f "build.gradle" ]; then
        echo "Building root project..."
        ./gradlew assembleDebug || gradle assembleDebug
        else
        echo "No build files found"
        fi
    
    # ==== 5. 添加调试步骤，检查构建输出 ====
    - name: Check build outputs
      run: |
        echo "=== 查找生成的 APK 文件 ==="
        # 在 app/ 目录中查找
        
        echo ""
        if [ -d "app/build/outputs" ]; then
        echo "在 app/build/outputs/ 中查找..."
        find app/build/outputs/ -name "*.apk" 2>/dev/null
        fi
        # 在当前目录查找
        find . -name "*.apk" 2>/dev/null || echo "没有找到 APK 文件"
        echo ""
        
        echo ""
        echo "=== 查看可能的构建输出 ==="
        find . -type d -name "outputs" 2>/dev/null
    
    # ==== 6. 修正的 Upload artifacts 步骤 ====
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: |
          app/build/outputs/apk/
          app/build/reports/
